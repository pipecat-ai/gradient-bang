# Supabase Migration Plan - Server-Only Architecture

**Last Updated:** 2025-11-09

## 1. Executive Summary
Gradient Bang is moving all persistent state and RPCs from the filesystem + FastAPI stack into a Supabase PostgreSQL project backed by Deno edge functions. The migration stays **server-only** (no public auth), keeps the legacy Python `AsyncGameClient` contract completely intact, and preserves the current integration tests without edits. Work is organized into six execution phases after Week 0 prep, with deterministic universe seeding and an isolated worktree that lets us roll back by redeploying todayâ€™s filesystem build.

**Running tests (short version)**
- Install/upgrade Python deps with `uv sync`.
- To let pytest boot the Supabase stack automatically, ensure:
  1. Docker is running locally.
  2. `npx supabase` (or `supabase` CLI) works from the repo root.
  3. `.env.supabase` exists (generated by `supabase start`).
- FastAPI path: `uv run pytest -q` (uses the filesystem backend on port 8002).
- Supabase preview: `USE_SUPABASE_TESTS=1 SUPABASE_URL=http://127.0.0.1:54321 EDGE_API_TOKEN=<token> uv run pytest tests/integration/test_corporation_*.py -q`. The fixtures will:
  - auto-start `supabase start` if Docker/CLI are available,
  - run `supabase db reset`, and
  - launch `supabase functions serve --env-file .env.supabase --no-verify-jwt`.
  If you prefer to manage the stack manually, export `SUPABASE_MANUAL_STACK=1` **and** start the same services yourself before running pytest.

Core architecture pillars:
- Server-to-server authentication with service-role keys stored in `.env`; edge functions enforce an `X-API-Token`.
- Deterministic world generation ("universe bang") instead of data migration; Supabase can be reset safely at any time.
- Realtime Broadcast channels per character + sector, with every RPC emitting events before returning.
- JSON-in/JSON-out contracts (no Pydantic), mirroring existing `AsyncGameClient` payloads so downstream tooling and tests run unmodified.
- Supabase CLI is invoked through `npx supabase â€¦` to keep Docker + CLI versions aligned across contributors.

## 2. Guardrails & Reference Info
### 2.1 Repository Footing (must stay accurate during the refactor)
- `game-server/`: existing FastAPI code. Leave directory name + import shim in `tests/conftest.py` untouched.
- `supabase/`: Supabase project (`config.toml`, `migrations/`, `functions/`). `_shared/` stores auth, request parsing, rate-limit, event, map, combat, and trading helpers reused by every edge function.
- `utils/`: Clients and helper scripts. `utils/api_client.py` remains the public entry point; `utils/supabase_client.py` provides the Supabase transport behind the same API.
- `npc/`, `pipecat/`, `tools/`, `scripts/`: Operator clients that must continue to import `AsyncGameClient` exactly as they do today.
- `tests/`: Async + integration suites. `tests/edge/` now runs the Supabase stack directly; `tests/integration/` is executed with `USE_SUPABASE_TESTS=1` but must not be edited for the migration.

### 2.2 Interface & Testing Invariants
- `AsyncGameClient` constructor signature, keyword-only args, event handlers, and coroutine names must remain byte-for-byte compatible. `utils/api_client.AsyncGameClient` simply dispatches to the Supabase implementation when `SUPABASE_URL`/`USE_SUPABASE_TESTS=1` is set.
- Category 1 tests (`tests/integration/test_game_server_api.py`, combat suites, economy suites, etc.) are never forked. We enforce parity by running them unchanged against the Supabase backend.
- Every newly ported RPC must (1) include the shared auth + rate limiting decorators, (2) emit the same realtime/event payloads as FastAPI, (3) update Supabase fixtures, and (4) pass the relevant unit, edge, and integration tests before it is considered complete.
- Realtime observability stays optional: only set `SUPABASE_REALTIME_DEBUG=1` when debugging. The flag fans out verbose logs to `logs/supabase-client.log` (pytest tails it automatically on timeouts).

### 2.3 Tooling & Commands to keep handy
- Install/update Python deps with `uv sync`. No ad-hoc virtualenvs.
- Reset Supabase locally with `npx supabase db reset`; seed data is pulled from `supabase/migrations/*.sql` and `scripts/universe-bang.py`.
- Serve edge functions during local work: `npx supabase functions serve --env-file .env.supabase.local`.
- Test harnesses:
  - Fast default: `uv run pytest -q` (filesystem backend).
  - Supabase integration: `USE_SUPABASE_TESTS=1 SUPABASE_URL=http://127.0.0.1:54321 uv run pytest tests/integration/test_game_server_api.py -k move -vv`.
  - Edge smoke tests: `USE_SUPABASE_TESTS=1 uv run pytest tests/edge -q` (fixture stands up Supabase via CLI and tears it down per session).
- Deterministic world data still lives under `world-data/`; the Supabase reset helper must regenerate it via `uv run scripts/universe-bang.py 5000 1234` before tests that depend on seeded characters.

## 3. Progress Snapshot (2025-11-09)
### 3.1 Completed deliverables
1. **Supabase project + migrations.** `supabase/config.toml` is checked in, and migrations like `20251108093000_initial_schema.sql`, `20251109121500_add_corporations.sql`, and `20251109170000_add_observer_channels.sql` cover the core schema, rate limits, realtime, and corporation metadata. `npx supabase db reset` now seeds deterministic data end-to-end.
2. **Shared helper stack.** `_shared/request.ts`, `auth.ts`, `rate_limiting.ts`, `events.ts`, `map.ts`, `status.ts`, `ships.ts`, and `trading.ts` encapsulate auth, validation, rate limits, payload builders, and event fan-out. Every function imported here uses the same error logging + telemetry fields.
3. **Supabase-native reset + parity harness.** `tests/helpers/supabase_reset.py` now truncates the full schema (universe_config/structure, ports, sector_contents, ships, characters, etc.), reloads the legacy `tests/test-world-data/*.json` fixtures (warps, ports, characters), and is wired into `tests/conftest.py` so `USE_SUPABASE_TESTS=1` bootstraps from the same deterministic map + roster as FastAPI. The helper still falls back to `npx supabase db reset` only when needed, and the first Supabase run of `tests/integration/test_combat_system.py::test_two_players_combat_attack_actions` now passes end-to-end.
4. **Edge parity + client coverage.** The missing `event_query` edge function shipped with Supabase-authenticated filters plus `tests/edge/test_event_query.py`, the Supabase client integration suite now uses deterministic `char_id(..)` helpers and pre-test resets (autouse fixture hits `test_reset` before every case), and the warp power/trade RPCs were brought to parity (`recharge_warp_power`, `transfer_warp_power`, AsyncGameClient trade buy) so the entire edge suite is green again.
5. **Ported edge functions.** `supabase/functions/{join,my_status,move,local_map_region,list_known_ports,plot_course,path_with_region,trade,purchase_fighters,ship_purchase,recharge_warp_power,transfer_warp_power,transfer_credits,bank_transfer,dump_cargo}/index.ts` all call into `_shared` helpers, emit the legacy events, and carry unit/edge coverage. Movement parity covers `movement.start`, `movement.complete`, and `map.local`.
6. **Event logging + realtime parity.** `_shared/events.ts` inserts into the `events` table and publishes to `public:character:{id}` / `public:sector:{id}` topics; `tests/edge/test_join.py`, `tests/edge/test_move.py`, and the Supabase AsyncGameClient smoke tests verify broadcasts before RPCs return.
7. **Supabase AsyncGameClient parity.** `utils/supabase_client.py` mirrors the legacy API (including the combat methods `combat_initiate`, `combat_action`, `combat_leave_fighters`, `combat_collect_fighters`, `combat_set_garrison_mode`), exposes the realtime debug toggle, and backs `utils/api_client.AsyncGameClient` without import churn. CI already runs the move subset against this transport.
8. **Economy/ship feature parity shipped.** `supabase/functions/purchase_fighters/index.ts`, `ship_purchase/index.ts`, `bank_transfer/index.ts`, `transfer_credits/index.ts`, and `_shared/trading.ts` re-implement fighter armories, trade-ins, corp-aware debits, and optimistic port locking while emitting the legacy `fighter.purchase`, `ship.traded_in`, and `trade.executed` events.
9. **Corporation schema + RPC plumbing.** `supabase/migrations/20251109121500_add_corporations.sql` adds `corporations`, `corporation_members`, `corporation_ships`, and the corporation-aware columns on `ship_instances` + `characters`. `_shared/corporations.ts` now centralizes invite code generation, membership upserts, ship summaries, and `emitCorporationEvent`, and the full RPC set (`corporation.create/join/leave/kick/regenerate_invite_code/list/info`, `my.corporation`) ships under `supabase/functions/corporation_*/` with coverage in `tests/edge/test_corporations.py`.
10. **Deterministic combat payloads.** Combat encounters seed their RNG from the combat_id, `combat.round_resolved` events compute fighter/shield deltas before mutating in-memory state, and the payload now shows `fighter_loss`/`shield_damage`, matching FastAPI expectations.

### 3.2 Known blockers / open issues
- **Combat fixtures.** `tests/integration/test_combat_system.py::TestBasicCombatScenarios::test_two_players_combat_attack_actions` still 409s because the Supabase reset helper does not seed the deterministic combat pilots/ships that the FastAPI suite expects. Until `supabase_reset_state()` (Phase 4) replays those fixtures, the combat suite cannot pass under Supabase.
- **Observer fan-out + event query.** `_shared/movement.ts` now re-emits realtime `character.moved`/garrison broadcasts, and the missing `supabase/functions/event_query` parity function is implemented (with `tests/edge/test_event_query.py` capturing the JSONL filters). The remaining follow-up is running the legacy FastAPI integration suites after the next server bring-up to double-check AsyncGameClient parity.
- **Docs + CI gap.** The Supabase-specific test workflow lives only in this plan. `AGENTS.md`, `CLAUDE.md`, and CI configs still describe the filesystem backend.

### 3.3 Immediate next steps (combat test unblock)
1. **Expand combat coverage.** With `test_two_players_combat_attack_actions` passing under Supabase transport, run `USE_SUPABASE_TESTS=1 uv run pytest tests/integration/test_combat_system.py -k "auto_engage or toll or garrison" -vv` (and ultimately the full file) to uncover any remaining encounter/garrison gaps.
2. **Broaden seeded scenarios.** Add the next wave of combat/economy fixtures directly into `tests/helpers/supabase_reset.py` (corp balances, toll garrisons, autopilot ships) so every Supabase run starts from the same deterministic world as FastAPI.
3. **Document & automate the workflow.** Capture the Supabase reset helper, debug flags (`SUPABASE_REALTIME_DEBUG=1`), and stack restart steps in `AGENTS.md`/`CLAUDE.md`, then add a CI leg that runs `npx supabase db reset && USE_SUPABASE_TESTS=1 uv run pytest tests/edge -q` plus the combat subset to prevent regressions.
4. **Admin/utility blockers.** Validate `scripts/character_create.py`, `scripts/character_modify.py`, and NPC tooling against the Supabase backend now that `join` no longer auto-creates characters; provide deterministic UUID helpers (already used in edge tests) plus a CI smoke script to ensure future admin endpoints keep parity.

### 3.4 Timeboxed execution plan (Week of 2025-11-10)
To push through the remaining Phase 2 scope, tackle the following day-by-day slices. Each row calls out the concrete artifacts we need plus the signal that the work is truly done.

| Date | Focus | Concrete deliverables | Exit criteria |
| --- | --- | --- | --- |
| Mon 2025-11-10 | Observer + movement fan-out | Finalize `_shared/movement.ts` occupant/garrison lookups, update `supabase/functions/{move,join}/index.ts` to emit sector + garrison broadcasts, and add `movement.observers.emitted` counters to structured logs. | `tests/edge/test_move_observers.py` and `tests/integration/test_event_system.py::test_character_moved_visibility` pass under Supabase transport with new logs visible. |
| Tue 2025-11-11 | Combat auto-engage + fixtures | Implement `_shared/combat.ts` enrollment helpers, wire garrison auto-engage payloads, regenerate combat fixtures inside `tests/helpers/supabase_reset.py`, and rerun the combat subset. | `USE_SUPABASE_TESTS=1 uv run pytest tests/integration/test_combat_system.py -k "auto_engage or toll or garrison" -vv` is green without FastAPI fallbacks. |
| Wed 2025-11-12 | Deterministic Supabase reset tooling | Finish the standalone `scripts/reset_supabase_state.py` entrypoint, seed corp balances/autopilots, and emit `logs/reset-summary.json` diffs for every reset run. | Full `tests/integration/test_combat_system.py` and `tests/integration/test_economy_paths.py` succeed after `npx supabase db reset` with the new helper. |
| Thu 2025-11-13 | Docs + CI propagation | Update `AGENTS.md`, `CLAUDE.md`, and `docs/runbooks/supabase.md` with Supabase-only workflow notes, and add a `supabase-edge` CI job that runs `npx supabase db reset && USE_SUPABASE_TESTS=1 uv run pytest tests/edge -q -k move`. | CI leg passes twice consecutively and publishes artifacts under `logs/ci-supabase/`; doc PR reviewed. |
| Fri 2025-11-14 | Realtime instrumentation & manual QA | Extend `_shared/events.ts` with `emitMultiSectorEvent`, observer metrics, and structured broadcast logs, then add `scripts/realtime_probe.py` + `tests/edge/test_combat_auto_engage.py` to validate per-sector delivery. | Subscriber probe shows <1â€¯s delivery for sector + character topics and realtime edge tests stay green. |

---

## 4. Phase Plan Overview
Each phase keeps the overall goals and completion criteria from the original plan but trims completed implementation details. Status legend: âœ… complete, ðŸŸ¡ in progress, â³ upcoming.

### Phase 0 â€“ Prep & Tooling (Week 0) âœ…
**Goals**
- Align on Supabase CLI/Docker workflow and environment naming.
- Produce reusable edge templates and capture design decisions.

**Whatâ€™s locked in**
- `supabase/config.toml`, `.env.supabase`, and local Docker scripts verified via `npx supabase start`.
- Template modules for readonly/mutation handlers live in `_shared/request.ts` and `_shared/auth.ts` and are documented inline.
- Design outcomes (events, combat, schema, testing) captured in `planning-files/supabase-migration-analysis.md` for quick reference.

**Completion criteria**
- Contributors can spin up Supabase locally in <5 minutes.
- Templates + helper stubs exist for all edge categories.

### Phase 1 â€“ Database Setup (Week 1) âœ…
**Goals**
- Define schema, constraints, and indexes in Supabase migrations.
- Seed deterministic universe, ship definitions, and corp metadata.

**Whatâ€™s locked in**
- Migrations listed in Â§3.1 cover 13 tables, FK constraints, indexes, and realtime channel grants.
- `scripts/universe-bang.py` produces deterministic seeds; `npx supabase db reset` invokes them via migrations.
- Ship economics now live in Supabase (`ship_definitions`, per-ship fighter counts) so trade-ins match `game-server/ships.py`.

**Completion criteria**
- Local Supabase reset produces identical data each run.
- FK + cascade behavior validated inside `tests/edge/test_schema_constraints.py` (see Appendix B for the checklist).

### Phase 2 â€“ Edge Functions + Event Delivery (Week 2) ðŸŸ¡
**Goals**
- Port every critical RPC together with event payload parity.
- Bring AsyncGameClient + integration suites online against Supabase transport.

**Complete so far**
- Movement, map, trade, fighter, ship, recharge, dump cargo, transfer credits/warp, and bank endpoints listed in Â§3.1.
- Shared auth/rate limiting/event stack hardened and reused widely.
- Supabase AsyncGameClient + move integration tests run unchanged with `USE_SUPABASE_TESTS=1`.

**Outstanding work (detailed)**
1. **Observer + combat fan-out**
   - Finalize `_shared/movement.ts` helpers for sector occupant lookups, garrison notifications, and `movement="depart"/"arrive"` payload builders.
   - Update `move/index.ts` and `join/index.ts` to call the helpers, emit per-sector broadcasts (excluding the actor), and log `movement.observers.emitted` counts.
   - Introduce `_shared/combat.ts` wrappers around `combat_find_active`, `combat_add_participant`, and `combat_start_with_garrisons` SQL functions; auto-enroll movers when hostile garrisons exist.
   - Tests: `tests/edge/test_move_observers.py`, `tests/integration/test_event_system.py::test_character_moved_visibility`, `tests/integration/test_combat_system.py::test_auto_engage_garrison` must pass with Supabase data.
2. **Economy parity polish**
   - Ensure `transfer_credits` and `bank_transfer` default to the clientâ€™s tracked character while honoring corp overrides; align error codes with FastAPI responses.
   - Extend fixtures in `tests/fixtures/economy.json` (or Supabase equivalent) so corp + personal accounts exist after `supabase_reset_state()`.
   - Regression coverage: `tests/integration/test_credit_locks.py`, `tests/integration/test_economy_paths.py`, and `tests/unit/test_bank_transfer.py` under Supabase transport.
3. **Docs + CI**
   - Document the Supabase workflow in `AGENTS.md`/`CLAUDE.md` (edge scaffolding, CLI commands, realtime debugging flag).
   - Add CI job: `npx supabase db reset && USE_SUPABASE_TESTS=1 uv run pytest tests/edge -q` plus the move subset (`-k move`). Store logs under `logs/ci-supabase/` for parity audits.

**Completion criteria**
- All movement + economy + observer tests pass through Supabase transport with zero test file edits.
- AsyncGameClient toggles between transports automatically (env-based) and remains transparent to callers.
- Documentation + CI describe and enforce the Supabase workflow.

### Phase 3 â€“ Event System Hardening & Realtime QA (Week 3) â³
**Goals**
- Validate multi-channel realtime delivery, rate limits, and telemetry.
- Exercise combat observers, per-sector broadcasts, and error reporting under load.

**Key tasks**
- Expand `_shared/events.ts` with `emitMultiSectorEvent` + observer metrics, then add structured logs for broadcast counts and delivery failures.
- Build Supabase-native smoke tests for combat + observer pipelines (`tests/edge/test_combat_auto_engage.py`, realtime subscriber harness in `tests/edge/helpers/realtime.py`).
- Instrument `npc/simple_tui` and the voice bot to consume Supabase realtime events end-to-end via `utils/supabase_client.py`.
- Add rate limit dashboards (leveraging Supabase metrics + logs) and alert thresholds.
- Harden realtime fan-out so it survives local and CI load (retry/backoff, sequential broadcasts, better error surfacing), then remove the temporary `EDGE_DISABLE_REALTIME` default and re-enable `tests/edge/test_supabase_client_integration.py` by default.

**Completion criteria**
- Realtime topics (`public:character:{id}`, `public:sector:{id}`) verified via automated tests and manual subscribers.
- Rate limiting proves effective via synthetic load (no false positives in move/join smoke tests).
- Combat observers auto-enroll pilots without FastAPI fallbacks.
- Full edge suite (including Supabase client integration tests) passes with realtime broadcasting enabled by default on both auto-managed and manual stacks.

### Phase 4 â€“ Data Tooling & Validation (Week 4) â³
**Goals**
- Turn deterministic seeding + reset paths into reusable tooling.
- Replace the FastAPI `test.reset` fixture with a Supabase-native helper. âœ… `supabase/functions/test_reset` now truncates/reseeds via SQL + fixture JSON, so AsyncGameClient can call the same RPC in Supabase mode.

**Key tasks**
- Implement `scripts/reset_supabase_state.py` (or similar) that truncates runtime tables, reruns migrations/seeds, and provisions deterministic test characters (combat pilots, corp accounts, observer bots).
- Update pytest fixtures to call the new reset helper directly (no HTTP hop). Share logic between `tests/edge`, `tests/integration`, and integration smoke scripts under `tests/helpers/`.
- Validate world data parity by diffing Supabase tables vs `world-data/` (target: 5,000 sectors, ~200 ports, corp seeds) and logging counts under `logs/world-validate.json`.

**Completion criteria**
- `supabase_reset_state()` fixture exists and is used by all Supabase-aware tests.
- Deterministic combat/economy characters appear automatically after each reset, unblocking the combat suites.
- Validation script reports zero drift between seeds and live tables.

### Recovery Status â€“ 2025-11-10
- A local cleanup inadvertently deleted the entire `supabase/` directory after the Week 2 edge-function work (test_reset, event_query, movement observers, shared helpers, fixtures). The directory was restored from `HEAD`, which means all in-progress Supabase code is currently missing.
- The pytest fixture briefly cloned `supabase/` into `.supabase-test-workdir/`, causing the Supabase CLI watcher to rewrite duplicate files and constantly restart the edge runtime; this directory has been removed, and the fixture now always invokes `supabase â€¦ --workdir supabase`.
- **Immediate recovery plan:**
  1. Re-create the Supabase project files exactly as described in `docs/supabase-migration-review-UPDATED.md` (test_reset, event_query, movement observers, `_shared` modules, fixtures).
  2. Re-run `npx supabase db reset --workdir supabase` followed by `UV run pytest tests/edge/test_admin_smoke.py -q` to verify the rebuilt functions.
  3. Recommit the Supabase directory to prevent accidental loss and add `scripts/recover_supabase.sh` (optional) documenting how to regenerate the folder from fixtures.
  4. Keep `.supabase-test-workdir/` out of the repo; rely solely on `--workdir supabase` when calling the CLI.

Until these recovery tasks are finished, treat the Supabase port as â€œdegradedâ€ and pause work on Phase 4+ items.

### Phase 5 â€“ Testing & Optimization (Week 5) â³
**Goals**
- Run the full integration suite against Supabase transport and capture latency metrics.
- Finalize the Supabase Python SDK integration for all bots/tools.

**Key tasks**
- Execute every file in `tests/integration/` with `USE_SUPABASE_TESTS=1`; log p50/p95/p99 latencies for `join`, `move`, `trade`, `my_status`, and critical corp/economy flows.
- Compare Supabase vs FastAPI metrics and document SLOs (p95 <200â€¯ms, p99 <500â€¯ms) in `docs/operations/perf-matrix.md`.
- Update `npc/run_npc.py`, `npc/simple_tui.py`, `tools/firehose_viewer.py`, and CLI scripts to import the Supabase client (no API changes required).
- Ensure `utils/supabase_realtime.py` (listener) mirrors the legacy event subscription API and is covered by unit tests.

**Completion criteria**
- All integration + edge suites pass against Supabase with logs stored for audit.
- Voice bot + NPC tooling operate solely on Supabase.
- Performance report attached to this plan + CLAUDE.md.

### Phase 6 â€“ Cutover & Deployment (Week 6) â³
**Goals**
- Validate, tag, and deploy the Supabase stack; monitor production.

**Key tasks**
- Pre-cutover checklist: confirm all 30+ edge functions deployed, secrets set via `npx supabase secrets set`, rate limits tuned, backups tested.
- Deployment runbook: tag `pre-supabase`, flip environment variables, restart voice bot/NPC services, and run smoke tests (join, move, trade, combat) immediately after.
- Post-cutover monitoring: track edge invocations, response times, error rates, realtime delivery latency, and billing alerts (50/75/90%).
- Documentation + runbooks in `docs/runbooks/supabase.md` cover troubleshooting, reset procedures, and rollback steps (deploy legacy worktree).

**Completion criteria**
- Production is Supabase-backed with <1% error rate and validated monitoring.
- Rollback remains a simple deploy of the legacy branch.
- Team-wide training + documentation completed.

---

## 5. Detailed Backlogs (Future Work Organization)
### 5.1 Database & Seeding Tasks
- **FK/constraint validation:** Track the Appendix B checklist (`sector_contents.port_id`, `characters.current_ship_id`, etc.) via a dedicated `tests/edge/test_schema_constraints.py` (add this file if it does not exist yet) so every cascade/constraint stays exercised.
- **Helper SQL functions:** `get_characters_aware_of_sector(sector_id)` (optional) can live in a migration once observer fan-out requires it.
- **Supabase reset helper:** Script under `scripts/reset_supabase_state.py` that truncates runtime tables, reruns migrations, copies deterministic combat/economy fixtures, and writes a JSON summary to `logs/reset-summary.json`.
- **Universe + corp seeds:** Ensure `supabase/migrations/*seed*.sql` (or `scripts/universe-bang.py --sql`) generates ships, ports, and corporation rows identical to the filesystem data. Include starter corp credits + autopilot characters for combat/economy tests.

### 5.2 Edge Function Coverage Map
| Domain | Functions (status) | Notes |
| --- | --- | --- |
| Character lifecycle | `join`, `my_status` âœ…; `character_create`, `character_delete`, `character_modify` â³ | Use shared auth + status builders; create/delete must emit `character.created`/`character.deleted` events and update corp tables.
| Movement/navigation | `move`, `plot_course`, `path_with_region`, `local_map_region` âœ… | Observer/garrison fan-out still pending (Â§4 Phase 2).
| Trade/economy | `trade`, `list_known_ports`, `dump_cargo`, `transfer_credits`, `bank_transfer`, `recharge_warp_power`, `transfer_warp_power`, `purchase_fighters` âœ… | Finish corp defaulting + locking behavior before closing Phase 2.
| Ship acquisition | `ship_purchase` âœ… | Ensure corp autopilot + trade-in telemetry stays in sync with `game-server/shipyard.py`.
| Combat | `combat_initiate`, `combat_action`, `combat_tick` (scaffolds exist) | Need Supabase fixtures plus `_shared/combat_*.ts` helpers to handle enrollment, timers, and victory resolution.
| Corporations | `corporation.create`, `corporation.join`, `corporation.leave`, `corporation.kick`, `corporation.regenerate_invite_code`, `corporation.list`, `corporation.info`, `my.corporation` âœ… | Shared helper `_shared/corporations.ts` drives membership + events; smoke coverage lives in `tests/edge/test_corporations.py`. Next up: admin corps (`corporation.modify/delete`) if/when they matter.

**Supabase integration gaps (Nov 2025)**
1. **Error parity:** `corporation.kick` currently returns 500 for several validation errors (kicking yourself, kicking someone outside the corp, non-existent characters). FastAPI returns 400/404. Fix the edge function to match legacy codes/messages so `tests/integration/test_corporation_errors.py` passes under Supabase.
2. **Credit overrides for tests:** FastAPI corp tests set ship credits via `managed_client(..., credits=...)` (updates knowledge/ships JSON). Supabase bypasses those files and reads DB state, so corp creation never fails with â€œInsufficient creditsâ€. Add a Supabase-specific reset hook (e.g., use `tests/edge/support/state.reset_character_state`) so the integration fixtures can set credits/sector/warp before each test when `USE_SUPABASE_TESTS=1`.
3. **Event payload mismatches:** `corporation.member_joined`, `corporation.member_left`, etc., are missing legacy fields (`member_id`, etc.) or emit different shapes. Align Supabase payloads with `game-server/api/corporation_*.py` and verify via `tests/integration/test_corporation_events.py`.

**Next steps:** patch the three gaps above, rerun `USE_SUPABASE_TESTS=1` corp integration suites, and then tackle remaining functional gaps (combat, salvage, admin endpoints).
| Salvage & events | `salvage_collect`, `send_message` pending (`event_query` âœ…) | `salvage_collect` uses `_shared/salvage.ts`; `event_query` now exposes pagination/filtering for clients to catch up; `send_message` allows admin broadcasts (per-character insert + broadcast).

### 5.3 SDK, Tooling, and Client Work
- `utils/supabase_realtime.py`: mirror the legacy `RealtimeEventListener` interface (`on`, `on_any`, `start`, `stop`), internally subscribe to `character:{id}` channels, and expose connection status callbacks.
- CLI & ops tools: Update `npc/run_npc.py`, `npc/simple_tui.py`, `pipecat_server/bot.py`, and `tools/*.py` scripts to rely on `utils/api_client.AsyncGameClient` without extra flags; only configuration change should be Supabase env vars.
- Documentation: `docs/runbooks/supabase.md` (local dev, debugging, reset), `AGENTS.md`/`CLAUDE.md` updates explaining the Supabase-only auth model, AsyncGameClient bridge, and troubleshooting for rate limits or realtime noise.

### 5.4 Testing & QA Backlog
- **Per-test reset:** Replace HTTP-based reset with Python fixtures that call `supabase_reset_state()`; share helper in `tests/helpers/server_fixture.py`. (New edge `test.reset` endpoint is also available for AsyncGameClient parity, and `tests/helpers/supabase_reset.py` now proxies to it before falling back to direct SQL. Supabase mode already triggers the RPC before each test via `tests/conftest.reset_test_state`; FastAPI path still needs to adopt the shared helper.)
- **Edge test expansion:** Ensure every edge function has at least one test under `tests/edge/` that (a) hits the function via Supabase CLI serve, (b) asserts DB side effects, and (c) verifies realtime payloads when applicable.
- **Integration coverage:** Nightly CI should run the entire `tests/integration/` matrix under both transports until Supabase fully replaces FastAPI. Log outputs under `logs/ci-supabase/` for debugging.
- **Manual smoke scripts:** Lightweight scripts in `scripts/` (e.g., `scripts/manual_credit_smoke.py`, `scripts/manual_combat_smoke.py`) that call Supabase endpoints directly to reproduce production issues.

### 5.5 Deployment & Monitoring Checklist
- Supabase secrets managed through `npx supabase secrets set` (no plain-text `.env` for production). Document required vars in Appendix B.
- Monitoring: enable Supabase dashboard alerts for invocation count, error rate, response latency, and billing thresholds; pipe key metrics into Grafana once Phase 5 perf work lands.
- Logging: centralize edge function logs (structured JSON) in `logs/edge/*.log` locally and configure production log drains (Supabase â†’ Logflare or similar) before cutover.
- Rollback: keep Supabase work in a dedicated worktree/branch so reverting is a deployment, not a data migration.

---

## 6. Risks & Mitigations
1. **Seed data integrity.** Mitigate with deterministic generators, `supabase_reset_state()`, and validation scripts that diff expected vs actual counts after each reset.
2. **Performance regressions.** Benchmark every critical RPC during Phase 5, add indexes where needed, and watch Supabase metrics for slow queries.
3. **Event delivery gaps.** Dual-write to the `events` table + realtime channels, and provide `event_query` so clients can replay missed payloads. Add structured `broadcast.*` logs when fan-out fails.
4. **Rate-limiting false positives.** Start with conservative limits stored in `_shared/rate_limiting.ts`, emit metrics on each throttle, and tune thresholds once telemetry accumulates.

## 7. Success Criteria
### Technical
- 100% of edge functions deployed and passing tests.
- `join`/`move` p95 <200â€¯ms, p99 <500â€¯ms (logged during Phase 5 test runs).
- Event delivery latency <1â€¯s and zero drops verified via subscriber tests.
- Seeds + Supabase state stay in sync (validation job passes).

### Functional
- Voice bot, NPC tooling, CLI scripts, and AsyncGameClient consumers operate solely via Supabase.
- Trading, combat, corp, and observer workflows behave identically to the filesystem backend (proved via unchanged integration tests).
- Map knowledge and universe data persist correctly across resets.

### Operational
- Team trained on Supabase operations; docs + runbooks updated.
- Monitoring + billing alerts configured at 50/75/90% of plan limits.
- Backup/restore and rollback procedures tested prior to cutover.

## 8. Post-Migration Enhancements (optional backlog)
After the server-only cutover stabilizes, we can consider multi-ship support, event partitioning, richer leaderboards, analytics dashboards, and a possible read-only public API with RLS. These are deliberately out-of-scope for the six-week migration but remain captured here for future planning.

## 9. Appendices
### Appendix A â€“ File-Based â†’ Supabase Mapping
| Legacy Source | Supabase Table | Notes |
| --- | --- | --- |
| `universe-generation-parameters.json` | `universe_config` | Singleton row storing generation seed/params |
| `universe_structure.json` | `universe_structure` | 5,000 deterministic rows |
| `port-states/sector_*.json` | `ports` | ~200 rows with stock + pricing |
| `sector_contents.json` | `sector_contents` | Dynamic salvage/combat state |
| `ships.json` | `ship_instances` | Includes `owner_type`, corp ownership, fighter counts |
| `characters.json` | `characters` | Player metadata + corp banking |
| `character-map-knowledge/*.json` | `characters.map_knowledge` | Stored as JSONB |
| `corporation_registry.json` | `corporations` | Name â†’ `corp_id` mapping |
| `corporations/*.json` | `corporation_members`, `corporation_ships` | Membership + fleet records |
| Garrison files | `garrisons` | Ownership + stance |

### Appendix B â€“ Environment Variables
Refer to `env.example` (repo root) and `pipecat/env.example` for full lists. Key values:
- `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_API_TOKEN` â€“ required for every server/client (voice bot, NPCs, tools, tests).
- `EDGE_API_TOKEN` â€“ shared secret validated by `_shared/auth.ts`.
- `USE_SUPABASE_TESTS=1`, `SUPABASE_REALTIME_DEBUG=1` â€“ opt-in flags for tests/debugging.
- `WORLD_DATA_DIR=world-data` â€“ ensures bang scripts and Supabase reset helpers read the same deterministic inputs.

### Appendix C â€“ Reference Commands
- Reset & seed: `npx supabase db reset`
- Serve functions: `npx supabase functions serve --env-file .env.supabase.local`
- Run Supabase move tests: `npx supabase db reset && USE_SUPABASE_TESTS=1 uv run pytest tests/integration/test_game_server_api.py -k move -vv`
- Run edge smoke tests: `USE_SUPABASE_TESTS=1 uv run pytest tests/edge -q`

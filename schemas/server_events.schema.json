{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://gradient-bang.dev/schemas/server-events.schema.json",
  "title": "Gradient Bang Server Messages",
  "type": "object",
  "oneOf": [
    {
      "$ref": "#/$defs/RpcSuccessFrame"
    },
    {
      "$ref": "#/$defs/RpcErrorFrame"
    },
    {
      "$ref": "#/$defs/EventFrame"
    }
  ],
  "$defs": {
    "RpcSuccessFrame": {
      "type": "object",
      "title": "RPC Success Frame",
      "required": [
        "frame_type",
        "id",
        "endpoint",
        "ok",
        "result"
      ],
      "properties": {
        "frame_type": {
          "const": "rpc"
        },
        "id": {
          "type": "string"
        },
        "endpoint": {
          "type": "string"
        },
        "ok": {
          "const": true
        },
        "result": {
          "type": "object"
        },
        "meta": {
          "$ref": "#/$defs/FrameMeta"
        }
      },
      "additionalProperties": false
    },
    "RpcErrorFrame": {
      "type": "object",
      "title": "RPC Error Frame",
      "required": [
        "frame_type",
        "id",
        "endpoint",
        "ok",
        "error"
      ],
      "properties": {
        "frame_type": {
          "const": "rpc"
        },
        "id": {
          "type": "string"
        },
        "endpoint": {
          "type": "string"
        },
        "ok": {
          "const": false
        },
        "error": {
          "type": "object",
          "required": [
            "status",
            "detail"
          ],
          "properties": {
            "status": {
              "type": "integer"
            },
            "detail": {
              "type": "string"
            },
            "code": {
              "type": "string"
            }
          },
          "additionalProperties": false
        },
        "meta": {
          "$ref": "#/$defs/FrameMeta"
        }
      },
      "additionalProperties": false
    },
    "EventFrame": {
      "type": "object",
      "title": "Server Event Frame",
      "required": [
        "frame_type",
        "event",
        "payload"
      ],
      "properties": {
        "frame_type": {
          "const": "event"
        },
        "event": {
          "$ref": "#/$defs/EventName"
        },
        "payload": {
          "type": "object"
        },
        "character_filter": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Optional list of character IDs the event targets."
        },
        "gg-action": {
          "type": "string",
          "description": "Backward-compatible alias for `event`."
        },
        "meta": {
          "$ref": "#/$defs/FrameMeta"
        },
        "tool_name": {
          "type": "string",
          "description": "Name of the tool associated with tool_call/tool_result events."
        }
      },
      "additionalProperties": false,
      "allOf": [
        {
          "if": {
            "properties": {
              "event": {
                "const": "status.init"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/StatusInitEvent"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "status.update"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/StatusUpdateEvent"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "character.joined"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/CharacterJoinedEvent"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "character.moved"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/CharacterMovedEvent"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "chat.message"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/ChatMessageEvent"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "local_map"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/LocalMapEvent"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "warp.transfer"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/WarpTransferEvent"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "warp.purchase"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/WarpPurchaseEvent"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "port.reset"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/PortResetEvent"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "port.regenerated"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/PortRegeneratedEvent"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "tool_call"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/ToolCallEvent"
              }
            },
            "required": [
              "tool_name"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "tool_result"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/ToolResultEvent"
              }
            },
            "required": [
              "tool_name"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "task_output"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/TaskOutputEvent"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "event": {
                "const": "task_complete"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "$ref": "#/$defs/TaskCompleteEvent"
              }
            }
          }
        }
      ]
    },
    "FrameMeta": {
      "type": "object",
      "description": "Optional metadata attached to a frame.",
      "properties": {
        "emitted_at": {
          "type": "string",
          "format": "date-time"
        },
        "event_version": {
          "type": "integer",
          "minimum": 1
        },
        "observed_by": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "request_id": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "EventName": {
      "type": "string",
      "enum": [
        "status.init",
        "status.update",
        "character.joined",
        "character.moved",
        "chat.message",
        "combat.started",
        "combat.round_waiting",
        "combat.round_resolved",
        "combat.ended",
        "sector.garrison_updated",
        "local_map",
        "warp.transfer",
        "warp.purchase",
        "port.reset",
        "port.regenerated",
        "tool_call",
        "tool_result",
        "task_output",
        "task_complete"
      ]
    },
    "StatusUpdateEvent": {
      "type": "object",
      "required": [
        "character_id",
        "name",
        "sector",
        "last_active",
        "ship",
        "sector_contents"
      ],
      "properties": {
        "character_id": {
          "type": "string"
        },
        "sector": {
          "type": "integer",
          "minimum": 0
        },
        "last_active": {
          "type": "string",
          "format": "date-time"
        },
        "ship": {
          "$ref": "#/$defs/ShipStatus"
        },
        "sector_contents": {
          "$ref": "#/$defs/SectorSnapshot"
        },
        "name": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "CharacterJoinedEvent": {
      "type": "object",
      "required": [
        "character_id",
        "sector",
        "timestamp"
      ],
      "properties": {
        "character_id": {
          "type": "string"
        },
        "sector": {
          "type": "integer",
          "minimum": 0
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },
    "CharacterMovedEvent": {
      "type": "object",
      "required": [
        "character_id",
        "from_sector",
        "to_sector",
        "timestamp"
      ],
      "properties": {
        "character_id": {
          "type": "string"
        },
        "from_sector": {
          "type": "integer",
          "minimum": 0
        },
        "to_sector": {
          "type": "integer",
          "minimum": 0
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "move_type": {
          "type": "string",
          "enum": [
            "normal",
            "teleport"
          ],
          "description": "Indicates whether the move was a standard adjacency hop or an admin teleport."
        }
      },
      "additionalProperties": false
    },
    "LocalMapNode": {
      "type": "object",
      "required": [
        "id",
        "visited",
        "adjacent",
        "is_leaf"
      ],
      "properties": {
        "id": {
          "type": "integer",
          "minimum": 0
        },
        "visited": {
          "type": "boolean"
        },
        "port_type": {
          "type": [
            "string",
            "null"
          ]
        },
        "adjacent": {
          "type": "array",
          "items": {
            "type": "integer",
            "minimum": 0
          }
        },
        "is_leaf": {
          "type": "boolean"
        }
      },
      "additionalProperties": false
    },
    "LocalMapEvent": {
      "type": "object",
      "required": [
        "character_id",
        "sector",
        "node_list"
      ],
      "properties": {
        "character_id": {
          "type": "string"
        },
        "sector": {
          "type": "integer",
          "minimum": 0
        },
        "max_hops": {
          "type": "integer",
          "minimum": 0
        },
        "max_sectors": {
          "type": "integer",
          "minimum": 1
        },
        "node_list": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/LocalMapNode"
          }
        }
      },
      "additionalProperties": false,
      "anyOf": [
        {
          "required": ["max_hops"]
        },
        {
          "required": ["max_sectors"]
        }
      ]
    },
    "ChatMessageEvent": {
      "type": "object",
      "required": [
        "id",
        "timestamp",
        "type",
        "from_name",
        "content"
      ],
      "properties": {
        "id": {
          "type": "integer",
          "minimum": 1
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "type": {
          "type": "string",
          "enum": [
            "broadcast",
            "direct"
          ]
        },
        "from_name": {
          "type": "string"
        },
        "content": {
          "type": "string"
        },
        "to_name": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "WarpTransferEvent": {
      "type": "object",
      "required": [
        "from_character_id",
        "to_character_id",
        "sector",
        "units",
        "timestamp"
      ],
      "properties": {
        "from_character_id": {
          "type": "string"
        },
        "to_character_id": {
          "type": "string"
        },
        "sector": {
          "type": "integer",
          "minimum": 0
        },
        "units": {
          "type": "integer",
          "minimum": 1
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },
    "WarpPurchaseEvent": {
      "type": "object",
      "required": [
        "character_id",
        "sector",
        "units",
        "price_per_unit",
        "total_cost",
        "timestamp"
      ],
      "properties": {
        "character_id": {
          "type": "string"
        },
        "sector": {
          "type": "integer",
          "minimum": 0
        },
        "units": {
          "type": "integer",
          "minimum": 1
        },
        "price_per_unit": {
          "type": "integer",
          "minimum": 0
        },
        "total_cost": {
          "type": "integer",
          "minimum": 0
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },
    "PortResetEvent": {
      "type": "object",
      "required": [
        "ports_reset",
        "timestamp"
      ],
      "properties": {
        "ports_reset": {
          "type": "integer",
          "minimum": 0
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },
    "PortRegeneratedEvent": {
      "type": "object",
      "required": [
        "ports_regenerated",
        "fraction",
        "timestamp"
      ],
      "properties": {
        "ports_regenerated": {
          "type": "integer",
          "minimum": 0
        },
        "fraction": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },
    "ShipStatus": {
      "type": "object",
      "required": [
        "ship_type",
        "ship_name",
        "cargo",
        "cargo_capacity",
        "cargo_used",
        "warp_power",
        "warp_power_capacity",
        "shields",
        "max_shields",
        "fighters",
        "max_fighters",
        "credits"
      ],
      "properties": {
        "ship_type": {
          "type": "string"
        },
        "ship_name": {
          "type": "string"
        },
        "cargo": {
          "type": "object",
          "additionalProperties": true,
          "properties": {
            "fuel_ore": {
              "type": "integer",
              "minimum": 0
            },
            "organics": {
              "type": "integer",
              "minimum": 0
            },
            "equipment": {
              "type": "integer",
              "minimum": 0
            }
          },
          "required": [
            "fuel_ore",
            "organics",
            "equipment"
          ]
        },
        "cargo_capacity": {
          "type": "integer",
          "minimum": 0
        },
        "cargo_used": {
          "type": "integer",
          "minimum": 0
        },
        "warp_power": {
          "type": "integer",
          "minimum": 0
        },
        "warp_power_capacity": {
          "type": "integer",
          "minimum": 0
        },
        "shields": {
          "type": "integer",
          "minimum": 0
        },
        "max_shields": {
          "type": "integer",
          "minimum": 0
        },
        "fighters": {
          "type": "integer",
          "minimum": 0
        },
        "max_fighters": {
          "type": "integer",
          "minimum": 0
        },
        "credits": {
          "type": "integer"
        }
      },
      "additionalProperties": false
    },
    "SectorSnapshot": {
      "type": "object",
      "required": [
        "port",
        "planets",
        "other_players",
        "adjacent_sectors"
      ],
      "properties": {
        "port": {
          "type": [
            "object",
            "null"
          ],
          "oneOf": [
            {
              "type": "null"
            },
            {
              "$ref": "#/$defs/PortSnapshot"
            }
          ]
        },
        "planets": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/PlanetSnapshot"
          }
        },
        "other_players": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/PlayerSnapshot"
          }
        },
        "adjacent_sectors": {
          "type": "array",
          "items": {
            "type": "integer",
            "minimum": 0
          }
        }
      },
      "additionalProperties": false
    },
    "PortSnapshot": {
      "type": "object",
      "required": [
        "code",
        "last_seen_prices",
        "last_seen_stock",
        "observed_at"
      ],
      "properties": {
        "code": {
          "type": "string",
          "pattern": "^[BS]{3}$"
        },
        "last_seen_prices": {
          "type": "object",
          "additionalProperties": {
            "oneOf": [
              {
                "type": "number"
              },
              {
                "type": "null"
              },
              {
                "type": "object",
                "required": [
                  "price_per_unit"
                ],
                "properties": {
                  "price_per_unit": {
                    "type": "number"
                  },
                  "note": {
                    "type": "string"
                  }
                },
                "additionalProperties": false
              }
            ]
          }
        },
        "last_seen_stock": {
          "type": "object",
          "additionalProperties": {
            "type": "integer",
            "minimum": 0
          }
        },
        "observed_at": {
          "type": "string",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },
    "PlanetSnapshot": {
      "type": "object",
      "required": [
        "id",
        "class_code",
        "class_name"
      ],
      "properties": {
        "id": {
          "type": "integer",
          "minimum": 0
        },
        "class_code": {
          "type": "string"
        },
        "class_name": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "PlayerSnapshot": {
      "type": "object",
      "required": [
        "name"
      ],
      "properties": {
        "name": {
          "type": "string"
        },
        "ship_type": {
          "type": "string",
          "description": "Last known ship type for the player, when available."
        }
      },
      "additionalProperties": false
    },
    "StatusInitEvent": {
      "type": "object",
      "required": [
        "status"
      ],
      "properties": {
        "status": {
          "$ref": "#/$defs/StatusUpdateEvent"
        },
        "map_data": {
          "oneOf": [
            {
              "type": "null"
            },
            {
              "$ref": "#/$defs/MyMapSnapshot"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "MyMapSnapshot": {
      "type": "object",
      "required": [
        "sector",
        "sectors_visited"
      ],
      "properties": {
        "sector": {
          "type": "integer",
          "minimum": 0
        },
        "sectors_visited": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/VisitedSector"
          }
        }
      },
      "additionalProperties": false
    },
    "VisitedSector": {
      "type": "object",
      "required": [
        "sector_id",
        "last_visited",
        "adjacent_sectors"
      ],
      "properties": {
        "sector_id": {
          "type": "integer",
          "minimum": 0
        },
        "last_visited": {
          "type": "string",
          "format": "date-time"
        },
        "port_info": {
          "oneOf": [
            {
              "type": "null"
            },
            {
              "$ref": "#/$defs/PortSnapshot"
            }
          ]
        },
        "adjacent_sectors": {
          "type": "array",
          "items": {
            "type": "integer",
            "minimum": 0
          }
        },
        "planets": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/PlanetSnapshot"
          }
        }
      },
      "additionalProperties": false
    },
    "ToolCallEvent": {
      "type": "object",
      "properties": {
        "arguments": {
          "description": "Arguments provided to the tool invocation.",
          "type": [
            "object",
            "array",
            "string",
            "number",
            "boolean",
            "null"
          ]
        }
      },
      "additionalProperties": true
    },
    "ToolResultEvent": {
      "type": "object",
      "properties": {
        "result": {
          "description": "Successful tool execution result payload.",
          "type": [
            "object",
            "array",
            "string",
            "number",
            "boolean",
            "null"
          ]
        },
        "error": {
          "description": "Error information if the tool failed.",
          "type": [
            "object",
            "array",
            "string",
            "number",
            "boolean",
            "null"
          ]
        }
      },
      "additionalProperties": true
    },
    "TaskOutputEvent": {
      "type": "object",
      "required": [
        "text"
      ],
      "properties": {
        "text": {
          "type": "string",
          "description": "Human-readable line of task progress to display."
        },
        "task_message_type": {
          "type": [
            "string",
            "null"
          ],
          "description": "Optional categorization for the output line."
        }
      },
      "additionalProperties": false
    },
    "TaskCompleteEvent": {
      "type": "object",
      "required": [
        "was_cancelled",
        "via_stop_tool"
      ],
      "properties": {
        "was_cancelled": {
          "type": "boolean",
          "description": "True when the task was cancelled before completion."
        },
        "via_stop_tool": {
          "type": "boolean",
          "description": "True if the task was cancelled via the stop_task tool."
        }
      },
      "additionalProperties": false
    }
  }
}
